sudo: required
language: node_js
node_js:
  - "stable"

cache:
directories:
  - node_modules

install:
  - sudo pip install awscli
before_script:
  - npm install
  - npm test
script:
  - npm run build
deploy:
  provider: s3
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  bucket: $S3_DEV_BUCKET
  skip_cleanup: true
  local-dir: public
  acl: public_read
  cache_control: "max-age=21600"
after_success:
branches:
  only:
    - master
    - develop
before_deploy:
  - aws s3 rm s3://$S3_DEV_BUCKET --recursive
after_deploy:
  - aws configure set preview.cloudfront true
  - test $TRAVIS_BRANCH = "master" && aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID_DEV --paths "/*"



# deploy:
#   provider: script
#   script: bash scripts/deploy.sh
#   on:
#     branch: master
#   env:
#     - ENV=dev DEPLOY_BUCKET=fp95-code-deploy

# language: node_js
# os: linux
# node_js:
#   - "stable"
# cache:
#   directories:
#     - "node_modules"
# jobs:
#   include:
#     - stage: Installing CLIs...
#       script:
#         - yes '' | sudo -H add-apt-repository ppa:deadsnakes/ppa
#         - sudo -H apt update
#         - sudo -H apt install python3.6
#         - python -V
#         - sudo -H apt install python3-pip python3-setuptools python3-wheel
#         - sudo -H pip3 install --upgrade pip
#         - sudo -H pip3 install awscli
#         - aws --version
#         - sudo -H pip3 install aws-sam-cli
#         - sam --version
#     - stage: Validating template...
#       script: sam validate --template scripts/template.yaml
#     - stage: Installing dependencies...
#       script: yarn install
#     - stage: Unit Tests
#       script: yarn run test
#     - stage: Produce Coverage
#       script: jest --coverage && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
# deploy:
#   provider: script
#   script: bash scripts/deploy.sh
#   on:
#     branch: master
#   env:
#     - ENV=dev DEPLOY_BUCKET=fp95-code-deploy

# matrix:
#   include:
#     - language: node_js
#       node_js:
#         - "stable"
#       cache:
#         directories:
#           - "node_modules"
#       jobs:
#         include:
#           - stage: Installing dependencies...
#             script: yarn install
#           - stage: Unit Tests
#             script: yarn test
#           # - stage: Produce Coverage
#           #   script: jest --coverage && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
#     - language: python
#       python:
#         - "3.6"
#       branches:
#         only:
#           - master
#       install:
#         - pip3 install awscli
#         - pip3 install aws-sam-cli

#         # JavaScript requirements
#         - sudo add-apt-repository -y ppa:chris-lea/node.js
#         - sudo apt-get -y update
#         - sudo apt-get -y install nodejs
#         - sudo npm install -g npx
#       script:
#         - sam validate --template scripts/template.yaml
#       before_deploy:
#         on:
#           branch: master
#         script:
#           - curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.0/install.sh | bash
#           - command -v nvm
#       deploy:
#         provider: script
#         script: bash scripts/deploy.sh
#         on:
#           branch: master
#         env:
#           - ENV=dev DEPLOY_BUCKET=fp95-code-deploy